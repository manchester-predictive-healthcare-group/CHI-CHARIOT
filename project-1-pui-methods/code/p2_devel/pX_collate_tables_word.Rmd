---
title: "Collate all results"
author: "Alex Pate"
date: "2025-05-14"
output: 
  word_document:
    number_sections: TRUE
    toc: TRUE
---

```{r setup, include=FALSE}
library(knitr)
```

* Model 0 = Non-causal model
* Model 1 = fix effect for antihypertensive use at baseline and during followup.
* Model 2 = fix effect for antihypertensive use at baseline and during followup, and model SBP unexposed to antihypertensive treatment.
* Model 3 = fix effect for BMI, SBP and Non-HDL cholesterol at baseline, fix effect for change in statin or antihypertensive use during followup.
* Model 4 = fix effect for change in statin or antihypertensive use during followup (model sbp/bmi/non-hdl cholesterol flexibly, intervention layer would follow.)
* Model 5 = fix effect for SBP at baseline, fix effect for change in statin or antihypertensive use during followup.
* Model 6 = fix effect for BMI at baseline, fix effect for change in statin or antihypertensive use during followup.
* Model 7 = fix effect for Non-HDL cholesterol at baseline, fix effect for change in statin or antihypertensive use during followup.


```{r, echo = FALSE}
### Read in female and male cohorts
cohort_female <- readRDS("../../data/cohort_female_pui.rds") |>
  as.data.frame()
cohort_male <- readRDS("../../data/cohort_male_pui.rds") |>
  as.data.frame()

### Turn dichotomous factor variables into 0/1 numeric
## Female cohort
for (var in colnames(cohort_female)){
  if (is.factor(cohort_female[, var])){
    if (length(levels(cohort_female[, var])) == 2){
      cohort_female[, var] <- as.numeric(cohort_female[, var]) - 1
    }
  }
}

## Male cohort
for (var in colnames(cohort_male)){
  if (is.factor(cohort_male[, var])){
    if (length(levels(cohort_male[, var])) == 2){
      cohort_male[, var] <- as.numeric(cohort_male[, var]) - 1
    }
  }
}

### Combine
cohort <- rbind(cohort_female, cohort_male)

###
### Calculate incidence rates for outcome
###

### Primary + Secondary + ONS
outcome.table.all <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time/365.25), sum_i = sum(cvd_indicator)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.all) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### Primary
outcome.table.primary <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_prim/365.25), sum_i = sum(cvd_indicator_prim)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.primary) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### Secondary
outcome.table.secondary <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_hes/365.25), sum_i = sum(cvd_indicator_hes)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.secondary) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### ONS
outcome.table.ons <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_death/365.25), sum_i = sum(cvd_indicator_death)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.ons) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

###
### Add a flag for whether its development or validation
###

### Read in the patids
patids.devel.female <- readRDS(paste("../../data/patids_devel_", 2, sep = ""))
patids.valid.female <- readRDS(paste("../../data/patids_valid_", 2, sep = ""))

patids.devel.male <- readRDS(paste("../../data/patids_devel_", 1, sep = ""))
patids.valid.male <- readRDS(paste("../../data/patids_valid_", 1, sep = ""))

### Split cohort
cohort_female <- subset(cohort, gender == 2)
cohort_male <- subset(cohort, gender == 1)

### Create flags
cohort_female <- dplyr::mutate(cohort_female,
                               dataset = as.numeric(!is.na(fastmatch::fmatch(cohort_female$patid, patids.devel.female))),
                               dataset = dplyr::case_when(dataset == 0 ~ "validation",
                                                          dataset == 1 ~ "development"))
cohort_male <- dplyr::mutate(cohort_male,
                             dataset = as.numeric(!is.na(fastmatch::fmatch(cohort_male$patid, patids.devel.male))),
                             dataset = dplyr::case_when(dataset == 0 ~ "validation",
                                                        dataset == 1 ~ "development"))

###
### Create table 1
###

### Entire cohort (split by gender)
cohort.table1 <- dplyr::select(cohort, -c(patid, pracid
                                          ,cvd_time, cvd_indicator
                                          ,cvd_time_prim, cvd_indicator_prim
                                          ,cvd_time_hes, cvd_indicator_hes
                                          ,cvd_time_death, cvd_indicator_death
                                          , fup_start, fup_end
                                          #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::mutate(gender = factor(gender, labels = c("Male", "Female")),
                smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = gender,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Baseline characteristics of individuals at the start of their follow up")

### Female
cohort.table1.female <- dplyr::select(cohort_female, -c(patid, pracid
                                                        ,cvd_time, cvd_indicator
                                                        ,cvd_time_prim, cvd_indicator_prim
                                                        ,cvd_time_hes, cvd_indicator_hes
                                                        ,cvd_time_death, cvd_indicator_death
                                                        , fup_start, fup_end
                                                        #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::mutate(smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = dataset,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Characteristics at baseline index date")

### Male
cohort.table1.male <- dplyr::select(cohort_male, -c(patid, pracid
                                                    ,cvd_time, cvd_indicator
                                                    ,cvd_time_prim, cvd_indicator_prim
                                                    ,cvd_time_hes, cvd_indicator_hes
                                                    ,cvd_time_death, cvd_indicator_death
                                                    , fup_start, fup_end
                                                    #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::mutate(smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = dataset,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Characteristics at baseline index date")

###
### Calibration
###

### Write function to extract results
create_row_calibration <- function(gender, model, dp){
  
  ### Read in relevant data
  ICI <- readRDS(paste("../../data/calib_ph_ICI_", gender, "_model", model, ".rds", sep = ""))
  E50 <- readRDS(paste("../../data/calib_ph_E50_", gender, "_model", model, ".rds", sep = ""))
  E90 <- readRDS(paste("../../data/calib_ph_E90_", gender, "_model", model, ".rds", sep = ""))
  
  ### Combine into vector and round
  calibration_entire_cohort <- c("ICI" = ICI, "E50" = E50, "E90" = E90)
  calibration_entire_cohort <- round(calibration_entire_cohort, dp)
  
  return(calibration_entire_cohort)
  
}

### Create tables
calib_table_female <- do.call("rbind", lapply(0:7, function(x){create_row_calibration(2, x, 3)})) |>
  as.data.frame() |>
  dplyr::mutate(model = 0:7) |>
  dplyr::relocate(model)
calib_table_male <- do.call("rbind", lapply(0:7, function(x){create_row_calibration(1, x, 3)})) |>
  as.data.frame() |>
  dplyr::mutate(model = 0:7) |>
  dplyr::relocate(model)


###
### Calibration for individuals with risks over 5%
###

### Write function to extract results
create_row_calibration_remove_low_risk <- function(gender, model, dp){
  
  ### Read in relevant data
  ICI <- readRDS(paste("../../data/calib_ph_remove_low_risk_ICI_", gender, "_model", model, ".rds", sep = ""))
  E50 <- readRDS(paste("../../data/calib_ph_remove_low_risk_E50_", gender, "_model", model, ".rds", sep = ""))
  E90 <- readRDS(paste("../../data/calib_ph_remove_low_risk_E90_", gender, "_model", model, ".rds", sep = ""))
  
  ### Combine into vector and round
  calibration_entire_cohort <- c("ICI" = ICI, "E50" = E50, "E90" = E90)
  calibration_entire_cohort <- round(calibration_entire_cohort, dp)
  
  return(calibration_entire_cohort)
  
}

### Create tables
calib_table_female_remove_low_risk <- do.call("rbind", lapply(0:7, function(x){create_row_calibration_remove_low_risk(2, x, 3)})) |>
  as.data.frame() |>
  dplyr::mutate(model = 0:7) |>
  dplyr::relocate(model)
calib_table_male_remove_low_risk <- do.call("rbind", lapply(0:7, function(x){create_row_calibration_remove_low_risk(1, x, 3)})) |>
  as.data.frame() |>
  dplyr::mutate(model = 0:7) |>
  dplyr::relocate(model)


###
### Discrimination
###

### Write function to extract results
create_row_discrimination <- function(gender, model, dp){
  
  ### Read in relevant data
  discrim_row <- readRDS(paste("../../data/discrim_", gender, "_model", model, ".rds", sep = ""))
  
  ### Retain relevant variables and round
  discrim_row <- discrim_row[c("index", "index_lower", "index_upper")]
  discrim_row <- round(discrim_row, dp)
  
  return(discrim_row)
  
}

### Create tables
discrim_table_female <- do.call("rbind", lapply(0:7, function(x){create_row_discrimination(2, x, 3)})) |>
  as.data.frame() |>
  dplyr::mutate(model = 0:7) |>
  dplyr::relocate(model)
discrim_table_male <- do.call("rbind", lapply(0:7, function(x){create_row_discrimination(1, x, 3)})) |>
  as.data.frame() |>
  dplyr::mutate(model = 0:7) |>
  dplyr::relocate(model)
```

# Baseline information

## Entire cohort

Baseline information

```{r, echo = FALSE}
cohort.table1
```

Outcome incidence rates

Outcome defined using composite of primary care, secondary care and ONS: 
```{r, echo = FALSE}
knitr::kable(outcome.table.all)
```

Primary care only:
```{r, echo = FALSE}
knitr::kable(outcome.table.primary)
```

Secondary care only:
```{r, echo = FALSE}
knitr::kable(outcome.table.secondary)
```

ONS death data only:
```{r, echo = FALSE}
knitr::kable(outcome.table.ons)
```

## Female cohort, split by development/validation

Baseline information

```{r, echo = FALSE}
cohort.table1.female
```

## Male cohort, split by development/validation

Baseline information

```{r, echo = FALSE}
cohort.table1.male
```

# Calibration

## Female

```{r, echo = FALSE}
knitr::kable(calib_table_female)
```

## Male

```{r, echo = FALSE}
knitr::kable(calib_table_male)
```

# Calibration, removing individuals with risks below 5% before calculating ICI, E50 and E90

## Female

```{r, echo = FALSE}
knitr::kable(calib_table_female_remove_low_risk)
```

## Male

```{r, echo = FALSE}
knitr::kable(calib_table_male_remove_low_risk)
```

# Discrimination

## Female

```{r, echo = FALSE}
knitr::kable(discrim_table_female)
```

## Male

```{r, echo = FALSE}
knitr::kable(discrim_table_male)
```