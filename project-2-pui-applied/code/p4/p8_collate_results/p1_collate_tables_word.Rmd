---
title: "Collate all results"
author: "Alex Pate"
date: "2025-05-14"
output: 
  word_document:
    number_sections: TRUE
---

```{r setup, include=FALSE}
library(knitr)
```

```{r, echo = FALSE}
# Start with the incidence tables
### Read in cohort
cohort <- readRDS("../../../data/p4/cohort_prototype3.rds")

###
### Calculate incidence rates for outcome
###

### Primary + Secondary + ONS
outcome.table.all <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time/365.25), sum_i = sum(cvd_indicator)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.all) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### Primary
outcome.table.primary <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_prim/365.25), sum_i = sum(cvd_indicator_prim)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.primary) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### Secondary
outcome.table.secondary <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_hes/365.25), sum_i = sum(cvd_indicator_hes)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.secondary) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### ONS
outcome.table.ons <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_death/365.25), sum_i = sum(cvd_indicator_death)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.ons) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

###
### Read in incidence rate tables by year and age
###
incidence_year_female <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_year_female.rds")
incidence_year_male <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_year_male.rds")

incidence_age <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_age.rds")
incidence_age_female <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_age_female.rds")
incidence_age_male <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_age_male.rds")
```

```{r, echo = FALSE}
# Derive the table1, cohort at baseline table, by split by development and validation
### Turn dichotomous factor variables into 0/1 numeric
for (var in colnames(cohort)){
  if (is.factor(cohort[,var])){
    if (length(levels(cohort[,var])) == 2){
      cohort[,var] <- as.numeric(cohort[,var]) - 1
    }
  }
}
###
### Add a flag for whether its development or validation
###

### Read in the patids
patids.devel.female <- readRDS(paste("../../../data/p4/patids_devel_", 2, sep = ""))
patids.valid.female <- readRDS(paste("../../../data/p4/patids_valid_", 2, sep = ""))

patids.devel.male <- readRDS(paste("../../../data/p4/patids_devel_", 1, sep = ""))
patids.valid.male <- readRDS(paste("../../../data/p4/patids_valid_", 1, sep = ""))

### Split cohort
cohort_female <- subset(cohort, gender == 2)
cohort_male <- subset(cohort, gender == 1)

### Create flags
cohort_female <- dplyr::mutate(cohort_female,
                               dataset = as.numeric(!is.na(fastmatch::fmatch(cohort_female$patid, patids.devel.female))),
                               dataset = dplyr::case_when(dataset == 0 ~ "validation",
                                                   dataset == 1 ~ "development"))
cohort_male <- dplyr::mutate(cohort_male,
                             dataset = as.numeric(!is.na(fastmatch::fmatch(cohort_male$patid, patids.devel.male))),
                             dataset = dplyr::case_when(dataset == 0 ~ "validation",
                                                 dataset == 1 ~ "development"))

###
### Create table 1
###

### Entire cohort (split by gender)
cohort.table1 <- dplyr::select(cohort, -c(patid, pracid
                                          ,cvd_time, cvd_indicator
                                          ,cvd_time_prim, cvd_indicator_prim
                                          ,cvd_time_hes, cvd_indicator_hes
                                          ,cvd_time_death, cvd_indicator_death
                                          ,bmi_alltime, sbp_alltime, sbp_var_alltime, cholhdl_ratio_alltime
                                          , fup_start, fup_end
                                          #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::mutate(gender = factor(gender, labels = c("Male", "Female")),
                smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = gender,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Baseline characteristics of individuals at the start of their follow up")

### Female
cohort.table1.female <- dplyr::select(cohort_female, -c(patid, pracid
                                                        ,cvd_time, cvd_indicator
                                                        ,cvd_time_prim, cvd_indicator_prim
                                                        ,cvd_time_hes, cvd_indicator_hes
                                                        ,cvd_time_death, cvd_indicator_death
                                                        ,bmi_alltime, sbp_alltime, sbp_var_alltime, cholhdl_ratio_alltime
                                                        , fup_start, fup_end
                                                        #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::mutate(smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = dataset,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Characteristics at baseline index date")

### Male
cohort.table1.male <- dplyr::select(cohort_male, -c(patid, pracid
                                                    ,cvd_time, cvd_indicator
                                                    ,cvd_time_prim, cvd_indicator_prim
                                                    ,cvd_time_hes, cvd_indicator_hes
                                                    ,cvd_time_death, cvd_indicator_death
                                                    ,bmi_alltime, sbp_alltime, sbp_var_alltime, cholhdl_ratio_alltime
                                                    , fup_start, fup_end
                                                    #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::mutate(smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = dataset,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Characteristics at baseline index date")
```

```{r, echo = FALSE}
###
### Calibration
###
create_table_calibration <- function(gender){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender]
  
  ### Read in validation dataset
  df_valid <- readRDS(paste("../../../data/p4/dfs_valid_", gender_char, ".rds", sep = ""))[[1]]
  
  ## Calibration in entire cohort
  ICI <- readRDS(paste("../../../data/p4/prototype3_calib_ph_ICI_d1v1_", gender, ".rds", sep = ""))
  E50 <- readRDS(paste("../../../data/p4/prototype3_calib_ph_E50_d1v1_", gender, ".rds", sep = ""))
  E90 <- readRDS(paste("../../../data/p4/prototype3_calib_ph_E90_d1v1_", gender, ".rds", sep = ""))
  calibration_entire_cohort <- c("N" = nrow(df_valid), "ICI" = ICI, "E50" = E50, "E90" = E90)
  
  ## Calibration by age
  calibration_by_age <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_age_cat_", gender, ".rds", sep = ""))
  
  ## Calibration by ethnicity
  calibration_by_ethnicity <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_ethnicity_", gender, ".rds", sep = ""))
  
  ## Calibration by region
  calibration_by_region <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_region_", gender, ".rds", sep = ""))
  
  ### Combine
  calibration_combined <- rbind(calibration_entire_cohort,
                                calibration_by_ethnicity,
                                calibration_by_age,
                                calibration_by_region)
  
  return(calibration_combined)
  
}


###
### Discrimination
###
create_table_discrimination <- function(gender){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender]
  
  ### Read in validation dataset
  df_valid <- readRDS(paste("../../../data/p4/dfs_valid_", gender_char, ".rds", sep = ""))[[1]]
  
  ### Discrimination in entire cohort
  discrimination_entire_cohort <- readRDS(paste("../../../data/p4/prototype3_discrim_d1v1_", gender, ".rds", sep = ""))
  discrimination_entire_cohort <- c("N" = nrow(df_valid), discrimination_entire_cohort)
  
  ### Discrimination by age
  discrimination_by_age <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_age_cat_", gender, ".rds", sep = ""))
  
  ### Discrimination by ethnicity
  discrimination_by_ethnicity <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_ethnicity_", gender, ".rds", sep = ""))
  
  ### Discrimination by region
  discrimination_by_region <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_region_", gender, ".rds", sep = ""))
  
  ### Combine
  discrimination_combined <- rbind(discrimination_entire_cohort,
                                   discrimination_by_ethnicity,
                                   discrimination_by_age,
                                   discrimination_by_region) |>
    dplyr::select(N, Cstat, Cstat_lower, Cstat_upper)
  
  return(discrimination_combined)
  
}

calibration_table_female <- create_table_calibration(2)
calibration_table_male <- create_table_calibration(1)

discrimination_table_female <- create_table_discrimination(2)
discrimination_table_male <- create_table_discrimination(1)
```

# Baseline information

## Entire cohort

Baseline information

```{r, echo = FALSE}
cohort.table1
```

Outcome incidence rates

Outcome defined using composite of primary care, secondary care and ONS: 
```{r, echo = FALSE}
knitr::kable(outcome.table.all)
```

Primary care only:
```{r, echo = FALSE}
knitr::kable(outcome.table.primary)
```

Secondary care only:
```{r, echo = FALSE}
knitr::kable(outcome.table.secondary)
```

ONS death data only:
```{r, echo = FALSE}
knitr::kable(outcome.table.ons)
```

## Female cohort

Baseline information

```{r, echo = FALSE}
cohort.table1.female
```

Outcome incidence rates

```{r, echo = FALSE}
kable(incidence_year_female)
```

## Male cohort

Baseline information

```{r, echo = FALSE}
cohort.table1.male
```

Outcome incidence rates

```{r, echo = FALSE}
kable(incidence_year_male)
```

# Model with 3 knots for age, calendar time not included as a variable in model

```{r, echo = FALSE}
age_knots <- 3
caltime <- FALSE
```

```{r, echo = FALSE}
###
### Calibration
###
create_table_calibration <- function(gender, age_knots, caltime){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender]
  
  ### Read in validation dataset
  df_valid <- readRDS(paste("../../../data/p4/dfs_valid_", gender_char, ".rds", sep = ""))[[1]]
  
  ## Calibration in entire cohort
  ICI <- readRDS(paste("../../../data/p4/prototype3_calib_ph_ICI_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  E50 <- readRDS(paste("../../../data/p4/prototype3_calib_ph_E50_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  E90 <- readRDS(paste("../../../data/p4/prototype3_calib_ph_E90_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  calibration_entire_cohort <- c("N" = nrow(df_valid), "ICI" = ICI, "E50" = E50, "E90" = E90)
  
  ## Calibration by age
  calibration_by_age <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_age_cat_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ## Calibration by ethnicity
  calibration_by_ethnicity <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_ethnicity_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ## Calibration by region
  calibration_by_region <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_region_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Combine
  calibration_combined <- rbind(calibration_entire_cohort,
                                calibration_by_ethnicity,
                                calibration_by_age,
                                calibration_by_region)
  
  return(calibration_combined)
  
}


###
### Discrimination
###
create_table_discrimination <- function(gender, age_knots, caltime){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender]
  
  ### Read in validation dataset
  df_valid <- readRDS(paste("../../../data/p4/dfs_valid_", gender_char, ".rds", sep = ""))[[1]]
  
  ### Discrimination in entire cohort
  discrimination_entire_cohort <- readRDS(paste("../../../data/p4/prototype3_discrim_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  discrimination_entire_cohort <- c("N" = nrow(df_valid), discrimination_entire_cohort)
  
  ### Discrimination by age
  discrimination_by_age <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_age_cat_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Discrimination by ethnicity
  discrimination_by_ethnicity <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_ethnicity_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Discrimination by region
  discrimination_by_region <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_region_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Combine
  discrimination_combined <- rbind(discrimination_entire_cohort,
                                   discrimination_by_ethnicity,
                                   discrimination_by_age,
                                   discrimination_by_region) |>
    dplyr::select(N, Cstat, Cstat_lower, Cstat_upper)
  
  return(discrimination_combined)
  
}
```

## Calibration tables

Female:

```{r, echo = FALSE}
calibration_table_female <- create_table_calibration(2, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

Male:

```{r, echo = FALSE}
calibration_table_male <- create_table_calibration(1, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

## Discrimination

Female:

```{r, echo = FALSE}
discrimination_table_female <- create_table_discrimination(2, age_knots, caltime)
knitr::kable(round(discrimination_table_female,3))
```

Male:

```{r, echo = FALSE}
discrimination_table_male <- create_table_discrimination(1, age_knots, caltime)
knitr::kable(round(discrimination_table_male,3))
```

# Model with 3 knots for age, calendar time included as a variable in model

```{r, echo = FALSE}
age_knots <- 4
caltime <- FALSE
```

## Calibration tables

Female:

```{r, echo = FALSE}
calibration_table_female <- create_table_calibration(2, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

Male:

```{r, echo = FALSE}
calibration_table_male <- create_table_calibration(1, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

## Discrimination

Female:

```{r, echo = FALSE}
discrimination_table_female <- create_table_discrimination(2, age_knots, caltime)
knitr::kable(round(discrimination_table_female,3))
```

Male:

```{r, echo = FALSE}
discrimination_table_male <- create_table_discrimination(1, age_knots, caltime)
knitr::kable(round(discrimination_table_male,3))
```

# Model with 4 knots for age, calendar time included as a variable in model

```{r, echo = FALSE}
age_knots <- 4
caltime <- TRUE
```

## Calibration tables

Female:

```{r, echo = FALSE}
calibration_table_female <- create_table_calibration(2, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

Male:

```{r, echo = FALSE}
calibration_table_male <- create_table_calibration(1, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

## Discrimination

Female:

```{r, echo = FALSE}
discrimination_table_female <- create_table_discrimination(2, age_knots, caltime)
knitr::kable(round(discrimination_table_female,3))
```

Male:

```{r, echo = FALSE}
discrimination_table_male <- create_table_discrimination(1, age_knots, caltime)
knitr::kable(round(discrimination_table_male,3))
```


