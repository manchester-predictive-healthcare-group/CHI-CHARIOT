---
title: "Collate all results"
author: "Alex Pate"
date: "2025-05-14"
output: 
  html_document:
    number_sections: TRUE
    toc: true
---

```{r, echo = FALSE}
# Start with the incidence tables
### Read in cohort
cohort <- readRDS("../../../data/p4/cohort_prototype3.rds")

###
### Calculate incidence rates for outcome
###

### Primary + Secondary + ONS
outcome.table.all <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time/365.25), sum_i = sum(cvd_indicator)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.all) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### Primary
outcome.table.primary <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_prim/365.25), sum_i = sum(cvd_indicator_prim)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.primary) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### Secondary
outcome.table.secondary <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_hes/365.25), sum_i = sum(cvd_indicator_hes)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.secondary) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

### ONS
outcome.table.ons <- cohort |>
  dplyr::filter(gender %in% c(1,2)) |>
  dplyr::group_by(factor(gender, labels = c("Male", "Female"))) |>
  dplyr::summarise(sum_t = sum(cvd_time_death/365.25), sum_i = sum(cvd_indicator_death)) |>
  dplyr::mutate(rate = 1000*sum_i/sum_t)
colnames(outcome.table.ons) <- c("Gender", "total follow up (years)", "n events", "rate (per 1000 years)")

###
### Read in incidence rate tables by year and age
###
incidence_year_female <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_year_female.rds")
incidence_year_male <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_year_male.rds")

incidence_age <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_age.rds")
incidence_age_female <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_age_female.rds")
incidence_age_male <- readRDS("../../../../../Aurum_Jun2021_extract/data/extraction/cohort_baseline/incidence_by_age_male.rds")
```

```{r, echo = FALSE}
# Derive the table1, cohort at baseline table, by split by development and validation
### Turn dichotomous factor variables into 0/1 numeric
for (var in colnames(cohort)){
  if (is.factor(cohort[,var])){
    if (length(levels(cohort[,var])) == 2){
      cohort[,var] <- as.numeric(cohort[,var]) - 1
    }
  }
}
###
### Add a flag for whether its development or validation
###

### Read in the patids
patids.devel.female <- readRDS(paste("../../../data/p4/patids_devel_", 2, sep = ""))
patids.valid.female <- readRDS(paste("../../../data/p4/patids_valid_", 2, sep = ""))

patids.devel.male <- readRDS(paste("../../../data/p4/patids_devel_", 1, sep = ""))
patids.valid.male <- readRDS(paste("../../../data/p4/patids_valid_", 1, sep = ""))

### Split cohort
cohort_female <- subset(cohort, gender == 2)
cohort_male <- subset(cohort, gender == 1)

### Create flags
cohort_female <- dplyr::mutate(cohort_female,
                               dataset = as.numeric(!is.na(fastmatch::fmatch(cohort_female$patid, patids.devel.female))),
                               dataset = dplyr::case_when(dataset == 0 ~ "validation",
                                                          dataset == 1 ~ "development"))
cohort_male <- dplyr::mutate(cohort_male,
                             dataset = as.numeric(!is.na(fastmatch::fmatch(cohort_male$patid, patids.devel.male))),
                             dataset = dplyr::case_when(dataset == 0 ~ "validation",
                                                        dataset == 1 ~ "development"))

###
### Create table 1
###

### Female
cohort.table1.female <- dplyr::select(cohort_female, -c(patid, pracid
                                                        ,cvd_time, cvd_indicator
                                                        ,cvd_time_prim, cvd_indicator_prim
                                                        ,cvd_time_hes, cvd_indicator_hes
                                                        ,cvd_time_death, cvd_indicator_death
                                                        ,bmi_alltime, sbp_alltime, sbp_var_alltime, cholhdl_ratio_alltime
                                                        , fup_start, fup_end
                                                        #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::mutate(smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = dataset,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Characteristics at baseline index date")

### Male
cohort.table1.male <- dplyr::select(cohort_male, -c(patid, pracid
                                                    ,cvd_time, cvd_indicator
                                                    ,cvd_time_prim, cvd_indicator_prim
                                                    ,cvd_time_hes, cvd_indicator_hes
                                                    ,cvd_time_death, cvd_indicator_death
                                                    ,bmi_alltime, sbp_alltime, sbp_var_alltime, cholhdl_ratio_alltime
                                                    , fup_start, fup_end
                                                    #, ethnicity.hes, ethnicity.prim
)) |>
  dplyr::mutate(smoking = forcats::fct_na_value_to_level(smoking, level = "Missing"),
                ethnicity = forcats::fct_na_value_to_level(ethnicity, level = "Missing")) |>
  gtsummary::tbl_summary(by = dataset,
                         type = gtsummary::all_continuous() ~  "continuous2",
                         missing = "no",
                         statistic = gtsummary::all_continuous() ~ c("{median} ({p5}, {p25}, {p75}, {p95})",
                                                                     "{N_miss} ({p_miss}%)")) |>
  gtsummary::modify_table_body(
    dplyr::mutate,
    label = ifelse(label == "N missing (% missing)",
                   "Missing",
                   label)) |>
  gtsummary::modify_caption("Characteristics at baseline index date")
```

# Baseline information

## Female cohort

Baseline information

```{r, echo = FALSE}
cohort.table1.female
```

Outcome incidence rates

```{r, echo = FALSE}
knitr::kable(incidence_year_female)
```

## Male cohort

Baseline information

```{r, echo = FALSE}
cohort.table1.male
```

Outcome incidence rates

```{r, echo = FALSE}
knitr::kable(incidence_year_male)
```

## Overall outcome incidence rates

Overall: 
```{r, echo = FALSE}
knitr::kable(outcome.table.all)
```

Primary care only:
```{r, echo = FALSE}
knitr::kable(outcome.table.primary)
```

Secondary care only:
```{r, echo = FALSE}
knitr::kable(outcome.table.secondary)
```

ONS death data only:
```{r, echo = FALSE}
knitr::kable(outcome.table.ons)
```

# Convergence plots for imputation

Female

```{r, echo = FALSE, out.width = "75%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/convergence_plot_prototype3", 2, ".png", sep = ""))
```


Male

```{r, echo = FALSE, out.width = "75%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/convergence_plot_prototype3", 1, ".png", sep = ""))
```

# Shape of non-linear effects interacted with age

Hazard ratio as age increases, interacted with each of the other predictor variables. The spline for age had knots at 25, 40, 55 and 70.

```{r, echo=FALSE, results = 'asis', dpi = 36}
library(knitr)

### Get list of variable names
var.binary <- readRDS("../../../data/p4/var_binary.rds")
var.poly <- readRDS("../../../data/p4/var_poly.rds")
var.cont <- readRDS("../../../data/p4/var_cont.rds")
var.cont <- c("caltime", var.cont)

### Define object, which will determine the models we present data for
savename <- "_"
```

## Interaction with binary variables

```{r,  echo = FALSE, out.width = "25%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/prototype3_4knots_caltime_assess_nonlinear", savename, var.binary, ".png", sep = ""))
```

## Interaction with polytomous variables

*Female Hazard Ratios*

```{r,  echo = FALSE, out.width = "33%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/prototype3_4knots_caltime_assess_nonlinear", savename, "2_", var.poly, ".png", sep = ""))
```

*Male Hazard Ratios*

```{r,  echo = FALSE, out.width = "33%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/prototype3_4knots_caltime_assess_nonlinear", savename, "1_", var.poly, ".png", sep = ""))
```

## Interaction with continuous variables

These plots show how the hazrd ratio of the variable of interst changes relative to a reference value, for a discrete range of ages. The reference value is 25 for BMI, 120 for SBP, 5 for SBP variability, and 3 for cholesterol/HDL ratio. Plotting from the 2.5th to p7.5th percentile.

Alternatively, I could plot how the hazard ratio comparing two fixed values (say 40 vs 25, 30 vs 25, and 20 vs 25) changes as age increases. This would arguably be more 'similar' to the other plots, but I think less informative.

*Female Hazard Ratios*

```{r,  echo = FALSE, out.width = "33%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/prototype3_4knots_caltime_assess_nonlinear", savename, "2_", var.cont, ".png", sep = ""))
```

*Male Hazard Ratios*

```{r,  echo = FALSE, out.width = "33%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/prototype3_4knots_caltime_assess_nonlinear", savename, "1_", var.cont, ".png", sep = ""))
```

## Hazard ratio for age

Hazard ratio is assessed at the mean of all other continuous variables, and the reference value for all categorical variables. the hazard ratio is relative to someone age 40.

```{r,  echo = FALSE, out.width = "100%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/prototype3_4knots_caltime_assess_nonlinear", savename, "age.png", sep = ""))
```

# Model evaluation at baseline (visit 0)

```{r, echo = FALSE}
### Set age_knots and caltime, to define the model of interest
age_knots <- 4
caltime <- TRUE
```

```{r, echo = FALSE}
###
### Calibration
###
create_table_calibration <- function(gender, age_knots, caltime){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender]
  
  ### Read in validation datase
  df_valid_nrow <- readRDS(paste("../../../data/p4/validation_cohort_N_", gender_char, ".rds", sep = ""))
  
  ## Calibration in entire cohort
  ICI <- readRDS(paste("../../../data/p4/prototype3_calib_ph_ICI_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  E50 <- readRDS(paste("../../../data/p4/prototype3_calib_ph_E50_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  E90 <- readRDS(paste("../../../data/p4/prototype3_calib_ph_E90_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  calibration_entire_cohort <- c("N" = df_valid_nrow, "ICI" = ICI, "E50" = E50, "E90" = E90)
  
  ## Calibration by age
  calibration_by_age <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_age_cat_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ## Calibration by ethnicity
  calibration_by_ethnicity <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_ethnicity_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ## Calibration by region
  calibration_by_region <- readRDS(paste("../../../data/p4/prototype3_calib_ph_table_d1v1_region_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Combine
  calibration_combined <- rbind(calibration_entire_cohort,
                                calibration_by_ethnicity,
                                calibration_by_age,
                                calibration_by_region)
  rownames(calibration_combined)[1] <- "Entire cohort"
  
  return(calibration_combined)
  
}


###
### Discrimination
###
create_table_discrimination <- function(gender, age_knots, caltime){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender]
  
  ### Read in validation datase
  df_valid_nrow <- readRDS(paste("../../../data/p4/validation_cohort_N_", gender_char, ".rds", sep = ""))
  
  ### Discrimination in entire cohort
  discrimination_entire_cohort <- readRDS(paste("../../../data/p4/prototype3_discrim_d1v1_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  discrimination_entire_cohort <- c("N" = df_valid_nrow, discrimination_entire_cohort)
  
  ### Discrimination by age
  discrimination_by_age <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_age_cat_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Discrimination by ethnicity
  discrimination_by_ethnicity <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_ethnicity_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Discrimination by region
  discrimination_by_region <- readRDS(paste("../../../data/p4/prototype3_discrim_table_d1v1_region_", gender, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
  
  ### Combine
  discrimination_combined <- rbind(discrimination_entire_cohort,
                                   discrimination_by_ethnicity,
                                   discrimination_by_age,
                                   discrimination_by_region) |>
    dplyr::select(N, Cstat, Cstat_lower, Cstat_upper) |>
    dplyr::rename(C_index = Cstat, index_lower = Cstat_lower, index_upper = Cstat_upper)
  rownames(discrimination_combined)[1] <- "Entire cohort"
  
  return(discrimination_combined)
  
}
```

## Calibration plots

### Calibration in the entire cohort

Female:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_MxM_", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
# knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

Male:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_MxM_", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
# knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

### Calibration by age

Female:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_age_cat_", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

Male:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_age_cat_", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

### Calibration by ethnicity

Female:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_ethnicity_", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

Male:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_ethnicity_", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

### Calibration by region

Female:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_region_", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

Male:

```{r, out.width = "100%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_calib_ph_d1v1_region_", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

## Calibration tables

Female:

```{r, echo = FALSE}
calibration_table_female <- create_table_calibration(2, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

Male:

```{r, echo = FALSE}
calibration_table_male <- create_table_calibration(1, age_knots, caltime)
knitr::kable(round(calibration_table_female,3))
```

## Discrimination

### Entire cohort

The mean (sd) and median (2.5th - 97.5th percentile range) across the results when validated in each development/validation pair.

Female:

```{r, echo = FALSE}
discrim_table <- readRDS(paste("../../../data/p4/prototype3_discrim_table_MxM", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
colnames(discrim_table) <- c("mean (sd)", "median (p2.5, p97.5)", "min", "max")
knitr::kable(discrim_table)
```

Male:

```{r, echo = FALSE}
discrim_table <- readRDS(paste("../../../data/p4/prototype3_discrim_table_MxM", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".rds", sep = ""))
colnames(discrim_table) <- c("mean (sd)", "median (p2.5, p97.5)", "min", "max")
knitr::kable(discrim_table)
```

### Across subgroups

Evaluated in one development/validation pair.

Female:

```{r, out.width = "50%",echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_discrimination_forestplot_", 2, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

```{r, echo = FALSE}
discrimination_table_female <- create_table_discrimination(2, age_knots, caltime)
knitr::kable(round(discrimination_table_female,3))
```

Male:

```{r, out.width = "50%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_discrimination_forestplot_", 1, "_nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

```{r, echo = FALSE}
discrimination_table_male <- create_table_discrimination(1, age_knots, caltime)
knitr::kable(round(discrimination_table_male,3))
```

## Instability plots

These instability pare plotted for 3,000 randomly selected individuals. The variation on the y-axis represents the expected variability in risk if the development cohort was to be re-sampled from the entire population which it represents, and a model was developed in these re-sampled cohorts. Naturally, variation increases as the predicted risk increases. We see a small number of individuals where the variability exceeds that of other individuals at their level of predicted risk. Looking at these individuals highlights them to be those with a higher number of risk factors.

```{r, out.width = "50%", echo = FALSE}
knitr::include_graphics(paste("../../../figures/p4/prototype3_stability_", c(2,1), "nk", age_knots, "_caltime", as.numeric(caltime), ".png", sep = ""))
```

# Temporal validation of initial risk estimation layer

Follow-up index dates are defined at 1/2/3/4/5 years after baseline. Calibration and discrimination are assessed at 5 and 10 years. 

In plots and tables, t_fup = number of days after baseline the index date is defined at, t_eval is denoting whether evaluating 5 or 10 year risk predictions.

```{r, echo = FALSE}
###
### Preliminaries
###

### Set whether calendar time is adjusted for in the model or not (0 = no, 1 = yes)
caltime_in <- 1

### Set number of knots for age
age_knots <- 4
```

```{r, echo = FALSE}
###
### Function to create calibration table for the initial risk estimation layer
###
create_calibration_table_initial <- function(gender_in){
  
  ### Set gender character version
  gender_char <- c("male", "female")[gender_in]
  
  ### Read in size of temporal validation datasets
  N <- readRDS("../../../data/p4/temporalv_N_initial.rds") |>
    subset(gender == gender_in) |>
    dplyr::pull(N)
  
  ### Extract ICI
  ICI <- do.call("c", 
                 lapply(c(5,10), function(y) {
                   do.call("c", 
                           lapply(round(365.25*(1:5)), function(x) {
                             readRDS(paste("../../../data/p4/temporalv_initial_prototype3_calib_ph_ICI_d1v1_", gender_in, 
                                           "_nk", age_knots, 
                                           "_caltime", caltime_in,
                                           "_tfup", x, 
                                           "_teval", y, ".rds", sep = ""))}))
                 })) |>
    round(3)
  
  ### Extract E50
  E50 <- do.call("c", 
                 lapply(c(5,10), function(y) {
                   do.call("c", 
                           lapply(round(365.25*(1:5)), function(x) {
                             readRDS(paste("../../../data/p4/temporalv_initial_prototype3_calib_ph_E50_d1v1_", gender_in, 
                                           "_nk", age_knots, 
                                           "_caltime", caltime_in,
                                           "_tfup", x, 
                                           "_teval", y, ".rds", sep = ""))}))
                 })) |>
    round(3)
  
  ### Extract E90
  E90 <- do.call("c", 
                 lapply(c(5,10), function(y) {
                   do.call("c", 
                           lapply(round(365.25*(1:5)), function(x) {
                             readRDS(paste("../../../data/p4/temporalv_initial_prototype3_calib_ph_E90_d1v1_", gender_in, 
                                           "_nk", age_knots, 
                                           "_caltime", caltime_in,
                                           "_tfup", x, 
                                           "_teval", y, ".rds", sep = ""))}))
                 })) |>
    round(3)
  
  ### Create table
  calib_table <- cbind(N, ICI, E50, E90) |>
    as.data.frame() |>
    dplyr::mutate(t_eval = c(rep(5,5), rep(10,5)),
                  t_fup = rep(1:5, 2),
                  gender = c("male", "female")[gender_in]) |>
    dplyr::relocate(gender, t_eval, t_fup) |>
    dplyr::rename(`follow-up visit` = t_fup, t = t_eval)
  
  return(calib_table)
  
}

###
### Function to create calibration table for the intervention layer
###
create_calibration_table_intervention <- function(gender_in){
  
  ### Get N for temporal validation cohorts that don't have missing data at baseline for each mfr
  N <- readRDS("../../../data/p4/temporalv_N_interventional.rds") |>
    subset(gender == gender_in)
  
  ### Create calibration table
  calibration_table <-
    ### rbind the output
    do.call("rbind", 
            ### Apply following functions over y (t_eval) = 5 and 10
            lapply(c(5,10), function(t_eval_in) {
              
              ### rbind the output 
              do.call("rbind", 
                      ### Apply following functions over different modifiable risk factors
                      lapply(c("sbp", "bmi", "nonhdl", "smoking"), function(mfr_in){
                        
                        ### Extract N vector
                        N_vec <- subset(N, mfr == mfr_in) |> dplyr::pull(N)
                        
                        ### Extract ICI
                        ICI <- do.call("c", 
                                       lapply(round(365.25*(1:5)), function(x) {
                                         readRDS(paste("../../../data/p4/temporalv_intervention_prototype3_calib_ph_ICI_d1v1_", gender_in, 
                                                       "_nk", age_knots, 
                                                       "_caltime", caltime_in,
                                                       "_tfup", x, 
                                                       "_teval", t_eval_in, 
                                                       "_", mfr_in, ".rds", sep = ""))})) |>
                          round(3)
                        
                        ### Extract E50
                        E50 <- do.call("c", 
                                       lapply(round(365.25*(1:5)), function(x) {
                                         readRDS(paste("../../../data/p4/temporalv_intervention_prototype3_calib_ph_E50_d1v1_", gender_in, 
                                                       "_nk", age_knots, 
                                                       "_caltime", caltime_in,
                                                       "_tfup", x, 
                                                       "_teval", t_eval_in, 
                                                       "_", mfr_in, ".rds", sep = ""))})) |>
                          round(3)
                        
                        ### Extract E90
                        E90 <- do.call("c", 
                                       lapply(round(365.25*(1:5)), function(x) {
                                         readRDS(paste("../../../data/p4/temporalv_intervention_prototype3_calib_ph_E90_d1v1_", gender_in, 
                                                       "_nk", age_knots, 
                                                       "_caltime", caltime_in,
                                                       "_tfup", x, 
                                                       "_teval", t_eval_in, 
                                                       "_", mfr_in, ".rds", sep = ""))})) |>
                          round(3)
                        
                        ### Create table
                        calib_table <- cbind(ICI, E50, E90) |>
                          as.data.frame() |>
                          dplyr::mutate(t_eval = t_eval_in,
                                        t_fup = 1:5,
                                        gender = c("male", "female")[gender_in],
                                        N = N_vec,
                                        mfr = mfr_in) |>
                          dplyr::relocate(gender, t_eval, mfr, t_fup, N)
                        
                        return(calib_table)
                        
                      }))
            }))
  
  calibration_table <- dplyr::rename(MFR = mfr, calibration_table, `follow-up visit` = t_fup, t = t_eval) |> 
    dplyr::mutate(MFR = dplyr::case_when(MFR == "sbp" ~ "systolic blood pressure",
                                         MFR == "bmi" ~ "body mass index",
                                         MFR == "nonhdl" ~ "non-HDL cholesterol",
                                         MFR == "smoking" ~ "smoking status"))
  return(calibration_table)
  
}

###
### Function to create discrimination table for the initial risk estimation layer
###
create_discrim_table_initial <- function(gender_in){
  
  ### Read in size of temporal validation datasets
  N <- readRDS("../../../data/p4/temporalv_N_initial.rds") |>
    subset(gender == gender_in) |>
    dplyr::pull(N)
  
  ### Get discrimination at t_eval == 5
  discrim_teval5 <- do.call("rbind", lapply(1:5, function(x) {readRDS(paste("../../../data/p4/temporalv_initial_prototype3_discrim_d1v1_", gender_in, 
                                                                            "_nk", 4,
                                                                            "_caltime", caltime_in,
                                                                            "_tfup", round(x*365.25), 
                                                                            "_teval", 5, ".rds", sep = ""))})) |>
    as.data.frame() |>
    dplyr::mutate(t_fup = 1:5, t_eval = "5 years", gender = c("male", "female")[gender_in], N = N) |>
    dplyr::relocate(gender, t_eval, t_fup, N) |>
    dplyr::select(gender, t_eval, t_fup, N, index, index_lower, index_upper) |>
    dplyr::rename(C_index = index, `follow-up visit` = t_fup, t = t_eval)
  
  ### Get discrimination for t_eval == 10
  discrim_teval10 <- do.call("rbind", lapply(1:5, function(x) {readRDS(paste("../../../data/p4/temporalv_initial_prototype3_discrim_d1v1_", gender_in, 
                                                                             "_nk", 4, 
                                                                             "_caltime", caltime_in,
                                                                             "_tfup", round(x*365.25), 
                                                                             "_teval", 10, ".rds", sep = ""))})) |>
    as.data.frame() |>
    dplyr::mutate(t_fup = 1:5, t_eval = "10 years", gender = c("male", "female")[gender_in], N = N) |>
    dplyr::relocate(gender, t_eval, t_fup, N) |>
    dplyr::select(gender, t_eval, t_fup, N, index, index_lower, index_upper) |>
    dplyr::rename(C_index = index, `follow-up visit` = t_fup, t = t_eval)
  
  discrim_table <- rbind(discrim_teval5, discrim_teval10)
  
  return(discrim_table)
}

###
### Function to create discrimination table for the intervention layer
###
create_discrim_table_intervention <- function(gender_in){
  
  ### Get N for temporal validation cohorts that don't have missing data at baseline for each mfr
  N <- readRDS("../../../data/p4/temporalv_N_interventional.rds") |>
    subset(gender == gender_in)
  
  ### Get discrimination for t_eval == 5
  discrim_teval5 <- do.call("rbind", lapply(c("sbp", "bmi", "nonhdl", "smoking"), function(mfr_in){
    
    ### Extract N vector
    N_vec <- subset(N, mfr == mfr_in) |> dplyr::pull(N)
    
    ### Read in discrimination data and create table
    do.call("rbind", lapply(1:5, function(x) {readRDS(paste("../../../data/p4/temporalv_intervention_prototype3_discrim_d1v1_", gender_in, 
                                                            "_nk", 4, 
                                                            "_caltime", caltime_in,
                                                            "_tfup", round(x*365.25), 
                                                            "_teval", 5, 
                                                            "_", mfr_in, ".rds", sep = ""))})) |>
      as.data.frame() |>
      dplyr::mutate(mfr = mfr_in, t_fup = 1:5, t_eval = "5 years", gender = c("male", "female")[gender_in], N = N_vec) |>
      dplyr::relocate(gender, t_eval, mfr, t_fup, N) |>
      dplyr::select(gender, t_eval, mfr, t_fup, N, index, index_lower, index_upper) |>
      dplyr::rename(MFR = mfr, C_index = index, `follow-up visit` = t_fup, t = t_eval)
  }))
  
  ### Get discrimination for t_eval == 10
  discrim_teval10 <- do.call("rbind", lapply(c("sbp", "bmi", "nonhdl", "smoking"), function(mfr_in){
    
    ### Extract N vector
    N_vec <- subset(N, mfr == mfr_in) |> dplyr::pull(N)
    
    ### Read in discrimination data and create table
    do.call("rbind", lapply(1:5, function(x) {readRDS(paste("../../../data/p4/temporalv_intervention_prototype3_discrim_d1v1_", gender_in, 
                                                            "_nk", 4, 
                                                            "_caltime", caltime_in,
                                                            "_tfup", round(x*365.25), 
                                                            "_teval", 10, 
                                                            "_", mfr_in, ".rds", sep = ""))})) |>
      as.data.frame() |>
      dplyr::mutate(mfr = mfr_in, t_fup = 1:5, t_eval = "10 years", gender = c("male", "female")[gender_in], N = N_vec) |>
      dplyr::relocate(gender, t_eval, mfr, t_fup, N) |>
      dplyr::select(gender, t_eval, mfr, t_fup, N, index, index_lower, index_upper) |>
      dplyr::rename(MFR = mfr, C_index = index, `follow-up visit` = t_fup, t = t_eval)
  }))
  
  discrim_table <- rbind(discrim_teval5, discrim_teval10) |>
    dplyr::mutate(MFR = dplyr::case_when(MFR == "sbp" ~ "systolic blood pressure",
                                         MFR == "bmi" ~ "body mass index",
                                         MFR == "nonhdl" ~ "non-HDL cholesterol",
                                         MFR == "smoking" ~ "smoking status"))
  
  return(discrim_table)
}
```

```{r, echo = FALSE}
###
### Apply these functions to create tables
###

### Extract and combine calibration of initial risk estimation layer
calibration_table_initial_female <- create_calibration_table_initial(2)
calibration_table_initial_male <- create_calibration_table_initial(1)
calibration_table_initial <- rbind(calibration_table_initial_female, calibration_table_initial_male)


### Extract and combine calibration of interventional layer
calibration_table_intervention_female <- create_calibration_table_intervention(2)
calibration_table_intervention_male <- create_calibration_table_intervention(1)
calibration_table_intervention <- rbind(calibration_table_intervention_female, calibration_table_intervention_male)

### Extract and combine discrimination of initial risk estimation layer
discrim_table_initial_female <- create_discrim_table_initial(2)
discrim_table_initial_male <- create_discrim_table_initial(1)
discirm_table_initial <- rbind(discrim_table_initial_female, discrim_table_initial_male)
discirm_table_initial[,c("C_index","index_lower","index_upper")] <- round(discirm_table_initial[,c("C_index","index_lower","index_upper")], 3)

### Extract and combine discrimination of interventional layer
discrim_table_intervention_female <- create_discrim_table_intervention(2)
discrim_table_intervention_male <- create_discrim_table_intervention(1)
discirm_table_intervention <- rbind(discrim_table_intervention_female, discrim_table_intervention_male)
discirm_table_intervention[,c("C_index","index_lower","index_upper")] <- round(discirm_table_intervention[,c("C_index","index_lower","index_upper")], 3)
```

## Calibration plots

### Female

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_initial_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_initial_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, ".png", sep = ""))
```

### Male

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_initial_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_initial_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, ".png", sep = ""))
```

## Calibration tables

```{r, echo = FALSE}
knitr::kable(calibration_table_initial)
```

## Discrimination

```{r, echo = FALSE}
knitr::kable(discirm_table_initial)
```

# Temporal validation of intervention layer

Follow-up index dates are defined at 1/2/3/4/5 years after baseline. Calibration and discrimination are assessed at 5 and 10 years. We assess interventional changes in each modifiable risk factor sequentially.

In plots and tables, t_fup = number of days after baseline the index date is defined at, t_eval is denoting whether evaluating 5 or 10 year risk predictions, mfr denotes the modifiable risk factor being evaluated.

## Calibration plots

### SBP

```{r, echo = FALSE}
mfr <- "sbp"
```

#### Female

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

#### Male

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

### BMI

```{r, echo = FALSE}
mfr <- "bmi"
```

#### Female

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

#### Male

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

### Non-HDL cholesterol

```{r, echo = FALSE}
mfr <- "nonhdl"
```

#### Female

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

#### Male

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

### Smoking status

```{r, echo = FALSE}
mfr <- "smoking"
```

#### Female

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 2, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

#### Male

```{r, echo = FALSE, out.width = "20%", fig.show = "hold", fig.align = "default"}
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 5, "_", mfr, ".png", sep = ""))
knitr::include_graphics(paste("../../../figures/p4/temporalv_intervention_prototype3_calib_ph_d1v1_", 1, "_nk", 4, "_caltime", caltime_in,"_tfup", round(c(1,2,3,4,5)*365.25), "_teval", 10, "_", mfr, ".png", sep = ""))
```

## Calibration tables

```{r, echo = FALSE}
knitr::kable(calibration_table_intervention)
```

## Discrimination

```{r, echo = FALSE}
knitr::kable(discirm_table_intervention)
```